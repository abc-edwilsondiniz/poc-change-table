SELECT
    p.numped,
    p.codclie,
    p.numorc,
    p.codvend,
    p.valped,
    p.valentrad,
    p.desconto,
    p.dtprevent,
    p.condpag,
    p.dtpripag,
    p.dtpedido,
    p.obs,
    p.numord,
    p.tpo,
    p.filial,
    p.referencia,
    p.moedcor,
    p.dataatu,
    p.ordprod,
    p.perfrete,
    p.valfrete,
    p.perseguro,
    p.valseguro,
    p.razaocli,
    p.endercli,
    p.bairrcli,
    p.cidadcli,
    p.cepcli,
    p.cgccli as cpf_cnpj,
    p.inscli,
    p.estcli,
    p.tipnota,
    p.codtran,
    p.codtran2,
    p.codendent,
    p.codendcob,
    p.observ,
    p.filialcli,
    p.respcli,
    p.respfor,
    p.tpoent,
    p.situacao,
    p.numpedfil,
    p.atuarec,
    p.numrom,
    p.pendente,
    p.libdesc,
    p.libcred,
    p.liblimi,
    p.libbloq,
    p.libatra,
    p.sitven,
    p.naoaprov,
    p.telecli,
    p.horaped,
    p.freteorc,
    p.numfrete,
    p.usucred,
    p.credito,
    p.libform,
    p.rformadepagar,
    p.codlis,
    p.tipofrete,
    p.codrote,
    p.SitConf,
    p.NumClie,
    p.ContribClie,
    p.FilialVend,
    p.destino,
    p.CodMens,
    p.Tributado,
    p.inscsufracli,
    p.COMPLCLI,
    p.sitmanut,
    p.codforout,
    p.deporigem,
    p.tpooutraent,
    p.Cqualidade,
    p.Refqualidade,
    p.condpagposterior,
    p.Etapa,
    p.valorfat,
    p.valorrec,
    p.taxanf,
    p.receber,
    p.tipovenda,
    p.oidrevenda,
    p.sitmon,
    p.temconjunto,
    p.txrevenda,
    p.SitCred,
    p.FlagEmit,
    p.sitsaga,
    p.dtvalidade,
    p.oidcontato,
    p.LIBTPDOC,
    p.Apelido,
    p.contato,
    p.PerDescto,
    p.reservaconjunto,
    p.viamont,
    p.TemSeguro,
    p.PLANOSEMJUROS,
    p.rcarenciaparcela,
    p.rdocplano,
    p.rdocentrada,
    p.ARQUIVOCDL,
    p.FatorEmpresa,
    p.Urgente,
    p.PERCIPISEGURO,
    p.OUTRASDESPESASINCLUSAS,
    p.libmarkmin,
    p.VIAORCAMENTO,
    p.ViaOrdemSeparacao,
    p.LIBPRAZOMEDIO,
    p.LIBFRETE,
    p.prazomedio,
    p.desmembrado,
    p.VALPEDTX,
    p.ORGAOPUBCLIE,
    p.ENDERECOFATURA,
    p.CONTRATO,
    p.EMPENHO,
    cli.nome AS nome_cliente,
    lower((select top 1 co.VALOR 
              from COMUNICACAO_V co 
              where co.RITEM = cli.oid and 
                   co.RTIPO = :rtipo)) as email_cliente
FROM CHANGETABLE (CHANGES [PEDICLICAD], :lastVersion) AS c
JOIN PEDICLICAD p on p.numped = c.numped
JOIN clientecad cli on cli.oid = p.codclie
